CREATE DATABASE DriveManagementDB;
GO

USE DriveManagementDB;
GO

CREATE TABLE Users (
    UserId INT IDENTITY(1,1) PRIMARY KEY,
    FullName VARCHAR(100),
    Email VARCHAR(150) UNIQUE,
    Phone VARCHAR(32) UNIQUE,
    IsActive BIT DEFAULT 1,
    CreatedDate DATETIME DEFAULT GETDATE(),
    UpdatedDate DATETIME NULL
);

CREATE TABLE Roles (
    RoleId INT IDENTITY(1,1) PRIMARY KEY,
    RoleName VARCHAR(20) UNIQUE -- SuperAdmin, HR, Mentor, Panel
);

CREATE TABLE UserRoles (
    UserRoleId INT IDENTITY(1,1) PRIMARY KEY,
    UserId INT NOT NULL,
    RoleId INT NOT NULL,
    FOREIGN KEY (UserId) REFERENCES Users(UserId),
    FOREIGN KEY (RoleId) REFERENCES Roles(RoleId),
    CONSTRAINT UQ_UserId_RoleId UNIQUE (UserId, RoleId)
);

CREATE TABLE UserPermissions (
    UserId INT NOT NULL,
    Action VARCHAR(20) NOT NULL,
    View BIT NOT NULL,
    Add BIT NOT NULL,
    Update BIT NOT NULL,
    Delete BIT NOT NULL,
    FOREIGN KEY (UserId) REFERENCES Users(UserId),
    CONSTRAINT UQ_UserId_Action UNIQUE (UserId, Action)
);

CREATE TABLE Requests (
    RequestId INT IDENTITY(1,1) PRIMARY KEY,
    RequestType VARCHAR(20), -- Add Role, Add Action
    SubType VARCHAR(30),  -- HR, Mentor, Panel, Drive-Add, Drive-View, Drive-Delete,
    Status VARCHAR(20) DEFAULT 'Pending', -- Pending, Approved, Rejected 
    ApprovedDate DATETIME NULL,
    RequestedBy INT NOT NULL,
    RequestedDate DATETIME DEFAULT GETDATE(),
    FOREIGN KEY (RequestedBy) REFERENCES Users(UserId),
);

CREATE TABLE Drives (
    DriveId INT IDENTITY(1,1) PRIMARY KEY,
    DriveName VARCHAR(200) UNIQUE,
    TechnicalRounds INT NOT NULL,
    CreatedBy INT NOT NULL,
    Status VARCHAR(20) DEFAULT 'Open', -- Open, Paused, Closed
    CreatedDate DATETIME DEFAULT GETDATE(),
    FOREIGN KEY (CreatedBy) REFERENCES Users(UserId)
);

CREATE TABLE DriveTeam (
    DriveTeamId INT IDENTITY(1,1) PRIMARY KEY,
    DriveId INT NOT NULL,
    UserId INT NOT NULL,
    RoleId INT NOT NULL,
    FOREIGN KEY (DriveId) REFERENCES Drives(DriveId),
    FOREIGN KEY (UserId) REFERENCES Users(UserId),
    FOREIGN KEY (RoleId) REFERENCES Roles(RoleId),
    CONSTRAINT UQ_DriveId_UserId UNIQUE (DriveId, UserId)
);

CREATE TABLE DriveRoleConfiguration (
    ConfigId INT IDENTITY(1,1) PRIMARY KEY,
    DriveId INT NOT NULL,
    RoleId INT NOT NULL,
    AllowPanelReassign BIT DEFAULT 0,
    CanViewFeedback BIT DEFAULT 0,
    AllowBulkUpload BIT DEFAULT 0,
    CanEditSubmittedFeedback BIT DEFAULT 0,
    RequireApprovalForReassignment BIT DEFAULT 0,
    FOREIGN KEY (DriveId) REFERENCES Drives(DriveId),
    FOREIGN KEY (RoleId) REFERENCES Roles(RoleId),
    CONSTRAINT UQ_UserId_RoleId UNIQUE (UserId, RoleId)
);

CREATE TABLE PanelVisibilitySettings (
    VisibilityId INT IDENTITY(1,1) PRIMARY KEY,
    DriveId INT NOT NULL UNIQUE,
    ShowPhone BIT DEFAULT 0,
    ShowEmail BIT DEFAULT 0,
    ShowPreviousCompany BIT DEFAULT 0,
    ShowResume BIT DEFAULT 0,
    ShowCollege BIT DEFAULT 0,
    ShowAddress BIT DEFAULT 0,
    ShowLinkedIn BIT DEFAULT 0,
    ShowGitHub BIT DEFAULT 0,
    FOREIGN KEY (DriveId) REFERENCES Drives(DriveId)
);

CREATE TABLE NotificationSettings (
    NotificationId INT IDENTITY(1,1) PRIMARY KEY,
    DriveId INT NOT NULL UNIQUE,
    EmailNotificationEnabled BIT DEFAULT 0,
    FOREIGN KEY (DriveId) REFERENCES Drives(DriveId)
);

CREATE TABLE FeedbackConfiguration (
    FeedbackConfigId INT IDENTITY(1,1) PRIMARY KEY,
    DriveId INT NOT NULL UNIQUE,
    OverallRatingRequired BIT DEFAULT 0,
    TechnicalSkillRequired BIT DEFAULT 0,
    CommunicationRequired BIT DEFAULT 0,
    ProblemSolvingRequired BIT DEFAULT 0,
    RecommendationRequired BIT DEFAULT 0,
    OverallFeedbackRequired BIT DEFAULT 0,
    FOREIGN KEY (DriveId) REFERENCES Drives(DriveId)
);

CREATE TABLE Candidates (
    CandidateId INT IDENTITY(1,1) PRIMARY KEY,
    FullName VARCHAR(100),
    Phone VARCHAR(32) UNIQUE,
    Email VARCHAR(150) UNIQUE,
    ResumeUrl VARCHAR(500),
    PreviousCompany VARCHAR(200),
    College VARCHAR(200),
    Address VARCHAR(500),
    LinkedInUrl VARCHAR(500),
    GitHubUrl VARCHAR(500),
    CreatedDate DATETIME DEFAULT GETDATE()
);

CREATE TABLE CandidateDrive (
    CandidateDriveId INT IDENTITY(1,1) PRIMARY KEY,
    CandidateId INT NOT NULL,
    DriveId INT NOT NULL,
    Status VARCHAR(20) DEFAULT 'Pending',  -- Pending, Selected, Rejected
    StatusSetBy INT NULL,
    CreatedDate DATETIME DEFAULT GETDATE(),
    FOREIGN KEY (CandidateId) REFERENCES Candidates(CandidateId),
    FOREIGN KEY (DriveId) REFERENCES Drives(DriveId),
    FOREIGN KEY (StatusSetBy) REFERENCES Users(UserId),
    CONSTRAINT UQ_CandidateId_DriveId UNIQUE (CandidateId, DriveId)
);

CREATE TABLE Rounds (
    RoundId INT IDENTITY(1,1) PRIMARY KEY,
    CandidateDriveId INT NOT NULL,
    PanelId INT NOT NULL,
    RoundType VARCHAR(20), -- Hr, Tech 1, Tech 2
    Status VARCHAR(20) DEFAULT 'Scheduled', -- Scheduled, OnProcess, Completed, Skipped
    Result VARCHAR(20) DEFAULT 'Pending', -- Pending, Selected, Rejected
    FOREIGN KEY (CandidateDriveId) REFERENCES CandidateDrive(CandidateDriveId),
    FOREIGN KEY (PanelId) REFERENCES Users(UserId),
    CONSTRAINT UQ_CandidateDriveId_PanelId UNIQUE (CandidateDriveId, PanelId)
);

CREATE TABLE CandidateReassignments (
    ReassignId INT IDENTITY(1,1) PRIMARY KEY,
    CandidateDriveId INT NOT NULL,
    PreviousUserId INT NOT NULL,
    NewUserId INT NOT NULL,
    RequestedBy INT NOT NULL,
    RequireApproval BIT,
    ApprovedBy INT NULL,
    ApprovedDate DATETIME NULL,
    RequestedDate DATETIME DEFAULT GETDATE(),
    FOREIGN KEY (CandidateDriveId) REFERENCES CandidateDrive(CandidateDriveId),
    FOREIGN KEY (PreviousUserId) REFERENCES Users(UserId),
    FOREIGN KEY (NewUserId) REFERENCES Users(UserId),
    FOREIGN KEY (RequestedBy) REFERENCES Users(UserId),
    FOREIGN KEY (ApprovedBy) REFERENCES Users(UserId)
);

CREATE TABLE Interviews (
    InterviewId INT IDENTITY(1,1) PRIMARY KEY,
    CandidateDriveId INT NOT NULL,
    PanelId INT NOT NULL,
    InterviewDate DATETIME NOT NULL,
    FOREIGN KEY (CandidateDriveId) REFERENCES CandidateDrive(CandidateDriveId),
    FOREIGN KEY (PanelId) REFERENCES Users(UserId),
    CONSTRAINT UQ_CandidateDriveId_PanelId UNIQUE (CandidateDriveId, PanelId)
);

CREATE TABLE Feedbacks (
    FeedbackId INT IDENTITY(1,1) PRIMARY KEY,
    InterviewId INT NOT NULL UNIQUE,
    OverallRating INT NULL,
    TechnicalSkill INT NULL,
    Communication INT NULL,
    ProblemSolving INT NULL,
    Recommendation VARCHAR(20), -- Hire, May be, No Hire
    OverallFeedback TEXT,
    SubmittedDate DATETIME DEFAULT GETDATE(),
    FOREIGN KEY (InterviewId) REFERENCES Interviews(InterviewId)
);
