-- USER TABLE
CREATE TABLE [user] (
    user_id INT IDENTITY(1,1) PRIMARY KEY,
    user_name VARCHAR(100) NOT NULL,
    email_id VARCHAR(250) NOT NULL UNIQUE,
    role VARCHAR(50) NOT NULL,
    phone_number VARCHAR(32) NOT NULL UNIQUE,
    is_active BIT NOT NULL,
    password_hash VARCHAR(MAX) NULL
);

-- SLOT TABLE
CREATE TABLE slot (
    slot_id INT IDENTITY(1,1) PRIMARY KEY,
    slot_date DATE NOT NULL,
    start_time VARCHAR(20) NOT NULL,
    end_time VARCHAR(20) NOT NULL
);

-- USER_SLOT TABLE
CREATE TABLE user_slot (
    user_slot_id INT IDENTITY(1,1) PRIMARY KEY,
    user_id INT NOT NULL,
    slot_id INT NOT NULL,
    is_locked BIT NOT NULL,
    CONSTRAINT UQ_user_slot UNIQUE (user_id, slot_id),
    CONSTRAINT FK_user_slot_user FOREIGN KEY (user_id) REFERENCES [user](user_id) ON UPDATE CASCADE ON DELETE CASCADE,
    CONSTRAINT FK_user_slot_slot FOREIGN KEY (slot_id) REFERENCES slot(slot_id) ON UPDATE CASCADE ON DELETE CASCADE
);

-- CANDIDATE TABLE
CREATE TABLE candidate (
    candidate_id INT IDENTITY(1,1) PRIMARY KEY,
    candidate_name VARCHAR(100) NOT NULL,
    email_id VARCHAR(250) NOT NULL,
    phone_number VARCHAR(32) NOT NULL,
    candidate_exp INT NOT NULL,
    current_position VARCHAR(150) NOT NULL,
    resume_url VARCHAR(100) NULL
);

-- FEEDBACK TABLE
CREATE TABLE feedback (
    feedback_id INT IDENTITY(1,1) PRIMARY KEY,
    star_rating INT NOT NULL,
    technical_skills VARCHAR(MAX) NOT NULL,
    communication_skills VARCHAR(MAX) NOT NULL,
    problem_solving_ability VARCHAR(MAX) NOT NULL,
    overall_feedback VARCHAR(MAX) NOT NULL,
    recommendation VARCHAR(20) NOT NULL
);

-- CANDIDATE_MAP TABLE
CREATE TABLE candidate_map (
    candidate_id INT NOT NULL,
    user_slot_id INT NOT NULL,
    scheduled_time VARCHAR(20) NOT NULL,
    is_present BIT NULL,
    interview_rounds INT NOT NULL,
    feedback_id INT NULL UNIQUE,
    PRIMARY KEY (candidate_id, user_slot_id),
    CONSTRAINT FK_candidate_map_candidate FOREIGN KEY (candidate_id) REFERENCES candidate(candidate_id) ON UPDATE CASCADE ON DELETE CASCADE,
    CONSTRAINT FK_candidate_map_user_slot FOREIGN KEY (user_slot_id) REFERENCES user_slot(user_slot_id) ON UPDATE CASCADE ON DELETE CASCADE,
    CONSTRAINT FK_candidate_map_feedback FOREIGN KEY (feedback_id) REFERENCES feedback(feedback_id) ON UPDATE CASCADE ON DELETE CASCADE
);

-- REASSIGN TABLE
CREATE TABLE reassign (
    reassign_id INT IDENTITY(1,1) PRIMARY KEY,
    candidate_id INT NOT NULL,
    old_userslot_id INT NOT NULL,
    new_userslot_id INT NOT NULL,
    reason VARCHAR(50) NOT NULL,
    additional_notes VARCHAR(MAX) NULL,

    CONSTRAINT FK_reassign_candidate FOREIGN KEY (candidate_id)
        REFERENCES candidate(candidate_id) ON UPDATE CASCADE ON DELETE CASCADE,

    CONSTRAINT FK_reassign_old_userslot FOREIGN KEY (old_userslot_id)
        REFERENCES user_slot(user_slot_id) ON UPDATE CASCADE ON DELETE CASCADE,

    CONSTRAINT FK_reassign_new_userslot FOREIGN KEY (new_userslot_id)
        REFERENCES user_slot(user_slot_id) ON UPDATE CASCADE ON DELETE CASCADE,
    CONSTRAINT UQ_reassign_candidate_slots UNIQUE (candidate_id, old_userslot_id, new_userslot_id)

);


-- Dummy Records to insert
-- USERS
INSERT INTO [user] (user_name, email_id, role, phone_number, is_active, password_hash) VALUES
('Alice Johnson', 'alice.johnson@example.com', 'Interviewer', '9876543210', 1, 'hash1'),
('Bob Smith', 'bob.smith@example.com', 'Recruiter', '9876543211', 1, 'hash2'),
('Charlie Brown', 'charlie.brown@example.com', 'Admin', '9876543212', 1, 'hash3'),
('Diana Prince', 'diana.prince@example.com', 'Interviewer', '9876543213', 0, 'hash4'),
('Edward Norton', 'edward.norton@example.com', 'Recruiter', '9876543214', 1, 'hash5');

-- SLOTS
INSERT INTO slot (slot_date, start_time, end_time) VALUES
('2025-12-09', '09:00', '10:00'),
('2025-12-09', '10:00', '11:00'),
('2025-12-09', '11:00', '12:00'),
('2025-12-10', '14:00', '15:00'),
('2025-12-10', '15:00', '16:00');

-- USER_SLOT
INSERT INTO user_slot (user_id, slot_id, is_locked) VALUES
(1, 1, 0),
(1, 2, 0),
(2, 3, 1),
(3, 4, 0),
(4, 5, 0);

-- CANDIDATES
INSERT INTO candidate (candidate_name, email_id, phone_number, candidate_exp, current_position, resume_url) VALUES
('Ethan Hunt', 'ethan.hunt@example.com', '9876543220', 5, 'Software Engineer', 'resume_ethan.pdf'),
('Fiona Gallagher', 'fiona.g@example.com', '9876543221', 3, 'QA Analyst', 'resume_fiona.pdf'),
('George Miller', 'george.m@example.com', '9876543222', 7, 'Team Lead', NULL),
('Hannah Lee', 'hannah.lee@example.com', '9876543223', 2, 'Intern', 'resume_hannah.pdf'),
('Ian Curtis', 'ian.curtis@example.com', '9876543224', 4, 'Backend Developer', 'resume_ian.pdf');

-- FEEDBACK
INSERT INTO feedback (star_rating, technical_skills, communication_skills, problem_solving_ability, overall_feedback, recommendation) VALUES
(5, 'Excellent C# and SQL knowledge', 'Clear and confident', 'Strong analytical skills', 'Outstanding candidate', 'Hire'),
(3, 'Good Java basics', 'Average communication', 'Needs guidance', 'Decent but not strong', 'Consider'),
(4, 'Solid Python expertise', 'Good communicator', 'Creative problem solver', 'Strong potential', 'Hire'),
(2, 'Weak fundamentals', 'Poor communication', 'Struggles with problem solving', 'Not suitable', 'Reject'),
(4, 'Strong cloud skills', 'Good collaboration', 'Handles complex issues well', 'Great fit for team', 'Hire');

-- CANDIDATE_MAP
INSERT INTO candidate_map (candidate_id, user_slot_id, scheduled_time, is_present, interview_rounds, feedback_id) VALUES
(1, 1, '09:00', 1, 2, 1),
(2, 2, '10:00', 1, 1, 2),
(3, 3, '11:00', 0, 3, 3),
(4, 4, '14:00', NULL, 1, NULL), -- no feedback yet
(5, 5, '15:00', 1, 2, 4);

-- REASSIGN
INSERT INTO reassign (candidate_id, old_userslot_id, new_userslot_id, reason, additional_notes) VALUES
(1, 1, 2, 'Rescheduled due to conflict', 'Candidate requested later slot'),
(2, 2, 3, 'Panel availability', 'Shifted to different interviewer'),
(3, 3, 4, 'Technical issue', 'Original slot cancelled'),
(4, 4, 1, 'Candidate preference', 'Preferred morning slot'),
(5, 5, 2, 'Overlap with another interview', 'Moved to earlier slot');

